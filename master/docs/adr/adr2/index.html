<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-adr/adr2" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.0">
<title data-rh="true">ADR 2: Steppable CEK machine | Plutus Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://plutus.readthedocs.io/plutus/master/docs/img/docusaurus-social-card.png"><meta data-rh="true" name="twitter:image" content="https://plutus.readthedocs.io/plutus/master/docs/img/docusaurus-social-card.png"><meta data-rh="true" property="og:url" content="https://plutus.readthedocs.io/plutus/master/docs/adr/adr2"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ADR 2: Steppable CEK machine | Plutus Documentation"><meta data-rh="true" name="description" content="Date: 2022-10"><meta data-rh="true" property="og:description" content="Date: 2022-10"><link data-rh="true" rel="icon" href="/plutus/master/docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://plutus.readthedocs.io/plutus/master/docs/adr/adr2"><link data-rh="true" rel="alternate" href="https://plutus.readthedocs.io/plutus/master/docs/adr/adr2" hreflang="en"><link data-rh="true" rel="alternate" href="https://plutus.readthedocs.io/plutus/master/docs/adr/adr2" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X6364ZT8L2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-X6364ZT8L2",{anonymize_ip:!0})</script><link rel="stylesheet" href="/plutus/master/docs/assets/css/styles.6c74e203.css">
<script src="/plutus/master/docs/assets/js/runtime~main.bd748d0b.js" defer="defer"></script>
<script src="/plutus/master/docs/assets/js/main.692ef450.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/plutus/master/docs/"><div class="navbar__logo"><img src="/plutus/master/docs/img/logo.svg" alt="Plutus Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/plutus/master/docs/img/logo.svg" alt="Plutus Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Plutus</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/plutus/master/docs/">User guide</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item"><a href="https://github.com/IntersectMBO/plutus" class="github-link" target="_blank"></a></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/plutus/master/docs/">Plutus user guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/plutus/master/docs/category/essential-concepts">Essential concepts</a><button aria-label="Expand sidebar category &#x27;Essential concepts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/plutus/master/docs/category/simple-example">Simple example</a><button aria-label="Expand sidebar category &#x27;Simple example&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/plutus/master/docs/category/using-plutus-tx">Using Plutus Tx</a><button aria-label="Expand sidebar category &#x27;Using Plutus Tx&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/plutus/master/docs/category/working-with-scripts">Working with scripts</a><button aria-label="Expand sidebar category &#x27;Working with scripts&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/plutus/master/docs/category/architectural-decision-records">Architectural decision records</a><button aria-label="Collapse sidebar category &#x27;Architectural decision records&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/plutus/master/docs/adr/adr-index">Architectural decision records</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/plutus/master/docs/adr/adr1">ADR 1: Record architectural decisions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/plutus/master/docs/adr/adr2">ADR 2: Steppable CEK machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/plutus/master/docs/adr/adr3">ADR 3: Sharing code between the production and debugging CEK machine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/plutus/master/docs/adr/adr4">ADR 4: Deferred unlifting in Plutus Core</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/plutus/master/docs/category/reference">Reference</a><button aria-label="Expand sidebar category &#x27;Reference&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/plutus/master/docs/troubleshooting">Troubleshooting</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/plutus/master/docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/plutus/master/docs/category/architectural-decision-records"><span itemprop="name">Architectural decision records</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">ADR 2: Steppable CEK machine</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 2: Steppable CEK machine</h1>
<p>Date: 2022-10</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="authors">Authors<a href="#authors" class="hash-link" aria-label="Direct link to Authors" title="Direct link to Authors">​</a></h2>
<p><a href="mailto:marty.stumpf@iohk.io" target="_blank" rel="noopener noreferrer">Marty Stumpf</a></p>
<p><a href="mailto:ziyang.liu@iohk.io" target="_blank" rel="noopener noreferrer">Ziyang Liu</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2>
<p>Proposed</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2>
<p>In order to have a minimal viable product of a debugger for Plutus, we need a CEK machine that will give us more information for debugging than our current one.</p>
<p>In order to provide debugging information for each evaluation step, we need a steppable CEK machine.
Implementing the steppable CEK machine is a non-trivial task and involves some design decisions.
One decision to make is about whether we can share the code between the production and the debugging machine.
That is not the scope of this ADR.
See the next ADR for that.</p>
<p>This ADR proposes a design for an implementation of a steppable CEK machine.
Of course, this doesn&#x27;t mean that this is the final decision.
This means that the next step for us is to prototype the machine in this way - which we have reasons to believe will go well.
We may adjust our proposed approach depending on how the prototyping goes.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2>
<p>This section describes the proposed implementation of the debugging machine.</p>
<p>We first <strong>abstract out the computation to &quot;steps&quot;</strong> on our current machine.
We then <strong>implement a coroutine system</strong> to add the debugging functionalities.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="abstracting-out-the-computation-to-steps">Abstracting out the computation to &quot;steps&quot;<a href="#abstracting-out-the-computation-to-steps" class="hash-link" aria-label="Direct link to Abstracting out the computation to &quot;steps&quot;" title="Direct link to Abstracting out the computation to &quot;steps&quot;">​</a></h3>
<p>This abstraction has been implemented in <a href="https://github.com/IntersectMBO/plutus/pull/4909/" target="_blank" rel="noopener noreferrer">PR#4909</a>.</p>
<p>The current machine inlined the steps.
We separate each steps into separate functions.
They all return a <code>CekState</code>:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- the next state is computing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">Computing</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WordArray</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Context</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Closure</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- the next state is returning</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Returning</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WordArray</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Context</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CekValue</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- evaluation finished</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Terminating</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Term</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NamedDeBruijn</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Closure</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">Closure</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Term</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NamedDeBruijn</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CekValEnv</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The computing step is <code>computeCekStep</code> with the following signature:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">computeCekStep</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">forall</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Ix</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PrettyUni</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GivenCekReqs</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WordArray</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Context</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Closure</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekM</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Similarly for the returning step (<code>returnCekStep</code>).
Then we link up all the steps with <code>continue</code>, and the machine behaves very similar to our current one:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">continue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token hvariable">forall</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Ix</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">PrettyUni</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">GivenCekReqs</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekM</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token hvariable">s</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Term</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NamedDeBruijn</span><span class="token plain"> </span><span class="token hvariable">uni</span><span class="token plain"> </span><span class="token hvariable">fun</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">continue</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Computing</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token hvariable">unbudgetedSteps</span><span class="token plain"> </span><span class="token hvariable">ctx</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Closure</span><span class="token plain"> </span><span class="token hvariable">term</span><span class="token plain"> </span><span class="token hvariable">env</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">computeCekStep</span><span class="token plain"> </span><span class="token hvariable">unbudgetedSteps</span><span class="token plain"> </span><span class="token hvariable">ctx</span><span class="token plain"> </span><span class="token hvariable">env</span><span class="token plain"> </span><span class="token hvariable">term</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">continue</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">continue</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Returning</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token hvariable">unbudgetedSteps</span><span class="token plain"> </span><span class="token hvariable">ctx</span><span class="token plain"> </span><span class="token hvariable">val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">returnCekStep</span><span class="token plain"> </span><span class="token hvariable">unbudgetedSteps</span><span class="token plain"> </span><span class="token hvariable">ctx</span><span class="token plain"> </span><span class="token hvariable">val</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">continue</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">continue</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Terminating</span><span class="token plain"> </span><span class="token hvariable">term</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">term</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="coroutines-in-haskell">Coroutines in Haskell<a href="#coroutines-in-haskell" class="hash-link" aria-label="Direct link to Coroutines in Haskell" title="Direct link to Coroutines in Haskell">​</a></h3>
<p>The next step is to add debugging capabilities between each step.
To do so, we implement it as a <em>coroutine system</em>.
A detailed introduction to coroutines in Haskell can be found in <a href="https://themonadreader.files.wordpress.com/2011/10/issue19.pdf" target="_blank" rel="noopener noreferrer">Coroutine Pipelines</a>.
This section gives a brief summary.</p>
<p>A coroutine system is composed of multiple computations cooperatively passing data and control to one another.
In this instance, one computation is the user issuing commands like &quot;step forward&quot;, and the other is the CEK machine processing the commands and performing actions like interpreting the script being debugged.
We&#x27;ll refer to them as the &quot;user computation&quot; and the &quot;machine computation&quot; respectively.</p>
<p>Coroutines in Haskell can be implemented using the free monad transformer, <a href="https://hackage.haskell.org/package/free/docs/Control-Monad-Trans-Free.html#t:FreeT" target="_blank" rel="noopener noreferrer">FreeT</a>.
The <code>Coroutine</code> type used in the above article is isomorphic to <code>FreeT</code>.</p>
<p>To use <code>FreeT f m</code>, we need two things: a suspension functor <code>f</code>, and a base monad <code>m</code>.</p>
<p>The suspension functor is a pattern functor that describes the ways the user computation can suspend and pass control to the machine computation.
Each constructor of the suspension functor should thus represent a user request, such as &quot;step forward&quot;.
Constructors generally follow a <code>RequestType request (response -&gt; a)</code> pattern.</p>
<p>As an example, consider the following suspension functor (the <code>uni</code> and <code>fun</code> parameters are omitted for readability):</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">data</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">StepF</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">LogF</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Text</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">InputF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Command</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">deriving</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Functor</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>StepF</code> passes a <code>CekState</code> to the machine computation and suspends, requesting the machine computation to progress one step, and send a <code>CekState</code> back.
<code>LogF</code> sends a <code>Text</code> to the machine computation (its response type is <code>()</code> and is omitted).
<code>InputF</code> requests a <code>Command</code> from the user.</p>
<p>Note that this pattern is not limited to a single suspension functor and two computations.
Multiple suspension functors and computations can be composed using <a href="https://www.cambridge.org/core/services/aop-cambridge-core/content/view/14416CB20C4637164EA9F77097909409/S0956796808006758a.pdf/data-types-a-la-carte.pdf" target="_blank" rel="noopener noreferrer">coproducts</a>.</p>
<p>The base monad <code>m</code> is the monad the machine computation runs in.
The machine computation interprets each request into an <code>m</code> action.
It is essentially a natural transformation from the suspension functor to <code>m</code>.
This <code>m</code> will replace our current monad <code>CekM</code>.
Although we can actually just use <code>CekM</code> in the steppable CEK machine when we add <code>IO</code> capabilities for debugging.
This is because we can convert it to/from <code>IO</code> via <code>unsafeSTToIO</code> and <code>unsafeIOToST</code>.</p>
<p>Suppose we define a type <code>SteppableCekM a</code> as our base monad <code>m</code>.
Then the machine computation can be implemented as the following request handler function:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">handle</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SteppableCekM</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">handle</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">StepF</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token hvariable">k</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">step</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token hvariable">k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">LogF</span><span class="token plain"> </span><span class="token hvariable">text</span><span class="token plain"> </span><span class="token hvariable">k</span><span class="token plain">  </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token builtin">log</span><span class="token plain"> </span><span class="token hvariable">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">k</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token constant" style="color:#36acaa">InputF</span><span class="token plain"> </span><span class="token hvariable">k</span><span class="token plain">     </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">input</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">.</span><span class="token plain"> </span><span class="token hvariable">k</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>where <code>step state</code>, <code>log text</code> and <code>input</code> return <code>SteppableCekM</code> actions.
<code>step</code> will likely correspond to <code>computeCekStep</code> and <code>returnCekStep</code> depending on the states.</p>
<p>We can then use <code>handle</code> to construct a monad morphism, interpreting the user computation (a <code>FreeT</code> structure) into a <code>SteppableCekM</code> action:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">runSteppableCek</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FreeT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SteppableCekM</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SteppableCekM</span><span class="token plain"> </span><span class="token hvariable">a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">runSteppableCek</span><span class="token plain"> </span><span class="token hvariable">userAction</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token hvariable">runFreeT</span><span class="token plain"> </span><span class="token hvariable">userAction</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">\</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">Pure</span><span class="token plain"> </span><span class="token hvariable">res</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">pure</span><span class="token plain"> </span><span class="token hvariable">res</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">Free</span><span class="token plain"> </span><span class="token hvariable">req</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token hvariable">handle</span><span class="token plain"> </span><span class="token hvariable">req</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;=</span><span class="token plain"> </span><span class="token hvariable">runSteppableCek</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To construct the user computation, <code>FreeT RequestF SteppableCekM</code>, we first provide helper functions for constructing <code>RequestF</code>s and lifting them into the <code>FreeT</code>:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">stepF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FreeT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">stepF</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">liftF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">StepF</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">logF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FreeT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">logF</span><span class="token plain"> </span><span class="token hvariable">text</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">liftF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">LogF</span><span class="token plain"> </span><span class="token hvariable">text</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">inputF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Monad</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FreeT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token hvariable">m</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">Command</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">inputF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token hvariable">liftF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">InputF</span><span class="token plain"> </span><span class="token builtin">id</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then we can implement the user computation like this:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">userComputation</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">CekState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FreeT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SteppableCekM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token hvariable">userComputation</span><span class="token plain"> </span><span class="token hvariable">currentState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token hvariable">cmd</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">inputF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token hvariable">cmd</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token constant" style="color:#36acaa">Step</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token hvariable">logF</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Received Step command&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token hvariable">mState</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">stepF</span><span class="token plain"> </span><span class="token hvariable">currentState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token hvariable">userComputation</span><span class="token plain"> </span><span class="token hvariable">mState</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We enter the debugging mode with the input UPLC program or term to debug with <code>enterDebug</code>:</p>
<div class="language-haskell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-haskell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token hvariable">enterDebug</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">::</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">UPLCTerm</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">FreeT</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">RequestF</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SteppableCekM</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token hvariable">enterDebug</span><span class="token plain"> </span><span class="token hvariable">termToDebug</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token hvariable">state</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token hvariable">stepF</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Computing</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token hvariable">toWordArray</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NoFrame</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">Closure</span><span class="token plain"> </span><span class="token hvariable">term</span><span class="token plain"> </span><span class="token hvariable">Env</span><span class="token hvariable punctuation" style="color:#393A34">.</span><span class="token hvariable">empty</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token hvariable">userComputation</span><span class="token plain"> </span><span class="token hvariable">state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="argument-coroutine-system">Argument: coroutine system<a href="#argument-coroutine-system" class="hash-link" aria-label="Direct link to Argument: coroutine system" title="Direct link to Argument: coroutine system">​</a></h3>
<p>Why a coroutine system?
In short, structuring the code this way will ease our future work.
Some of the advantages are mentioned above already.
Here is a summary:</p>
<ul>
<li>The debugger is naturally a coroutine, where one routine is the user and the other is the CEK machine, and they take turns to suspend and pass data and control to each other in a debugging session. The literature has contributed a good way to design/implement a coroutine. It makes sense to implement a well studied design.</li>
<li>We can probably reuse the same monad (<code>CekM</code>) in the steppable CEK machine, because we can convert it to/from <code>IO</code> via <code>unsafeSTToIO</code> and <code>unsafeIOToST</code>.</li>
<li>It should be easier when we add more functionalities because multiple suspension functors and computations can be composed using <a href="https://www.cambridge.org/core/services/aop-cambridge-core/content/view/14416CB20C4637164EA9F77097909409/S0956796808006758a.pdf/data-types-a-la-carte.pdf" target="_blank" rel="noopener noreferrer">coproducts</a>.</li>
<li>This should also play nicely when we implement Debug Adapter Protocol for the debugger later on.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implications">Implications<a href="#implications" class="hash-link" aria-label="Direct link to Implications" title="Direct link to Implications">​</a></h2>
<p>In summary, we proposed to implement the debugging machine as a coroutine system with &#x27;steps&#x27;.
This implies that:</p>
<ul>
<li>We have to maintain the CEK machine (eg, we need to check its conformance)</li>
<li>We will add a debugger for our users providing them with more information at each evaluation step</li>
<li>We will need to write some tests to ensure that the debugging machine continuously outputs reasonable information.</li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/IntersectMBO/plutus/edit/master/docusaurus/docs/adr/adr2.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/plutus/master/docs/adr/adr1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ADR 1: Record architectural decisions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/plutus/master/docs/adr/adr3"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ADR 3: Sharing code between the production and debugging CEK machine</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#authors" class="table-of-contents__link toc-highlight">Authors</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a><ul><li><a href="#abstracting-out-the-computation-to-steps" class="table-of-contents__link toc-highlight">Abstracting out the computation to &quot;steps&quot;</a></li><li><a href="#coroutines-in-haskell" class="table-of-contents__link toc-highlight">Coroutines in Haskell</a></li><li><a href="#argument-coroutine-system" class="table-of-contents__link toc-highlight">Argument: coroutine system</a></li></ul></li><li><a href="#implications" class="table-of-contents__link toc-highlight">Implications</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="footer-container"><div class="footer-left"><img class="footer-logo" src="/plutus/master/docs/img/logo-footer.svg" alt="Plutus"><span>Copyright ©<!-- -->2024<!-- --> IOHK. Built with Docusaurus.</span></div><div class="footer-right"><a href="/plutus/master/docs/">User Guide</a><a href="https://github.com/IntersectMBO/plutus" class="github-link" target="_blank"></a></div></div></footer></div>
</body>
</html>