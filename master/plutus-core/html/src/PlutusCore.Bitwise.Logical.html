<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- editorconfig-checker-disable-file</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="annot"><span class="hs-comment">-- | Implementations of bitwise logical primops.</span></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusCore.Bitwise.Logical</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-7"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#andByteString"><span class="hs-identifier">andByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#orByteString"><span class="hs-identifier">orByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#xorByteString"><span class="hs-identifier">xorByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#complementByteString"><span class="hs-identifier">complementByteString</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#readBit"><span class="hs-identifier">readBit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#writeBits"><span class="hs-identifier">writeBits</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#replicateByteString"><span class="hs-identifier">replicateByteString</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier">Exception</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Exception.html#throw"><span class="hs-identifier">throw</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Control.Exception.Base.html#try"><span class="hs-identifier">try</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Bits.html"><span class="hs-identifier">Data.Bits</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Bits</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Internal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BSI</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier">for_</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#traverse_"><span class="hs-identifier">traverse_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">pack</span></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier">Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier">Word8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Marshal.Utils.html"><span class="hs-identifier">Foreign.Marshal.Utils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier">copyBytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Ptr.html"><span class="hs-identifier">Foreign.Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier">Ptr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier">castPtr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier">plusPtr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html"><span class="hs-identifier">Foreign.Storable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekByteOff"><span class="hs-identifier">peekByteOff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier">peekElemOff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier">pokeByteOff</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier">pokeElemOff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.html"><span class="hs-identifier">PlutusCore.Builtin</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinResult"><span class="hs-identifier">BuiltinResult</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier">emit</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Evaluation.Result.html"><span class="hs-identifier">PlutusCore.Evaluation.Result</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier">evaluationFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/System.IO.Unsafe.html"><span class="hs-identifier">System.IO.Unsafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier">unsafeDupablePerformIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-comment">{- Note [Binary bitwise operation implementation and manual specialization]

   All of the 'binary' bitwise operations (namely `andByteString`,
   `orByteString` and `xorByteString`) operate similarly:

   1. Decide which of their two `ByteString` arguments determines the length
      of the result. For padding semantics, this is the _longer_ argument,
      whereas for truncation semantics, it's the _shorter_ one. If both
      `ByteString` arguments have identical length, it doesn't matter which we
      choose.
   2. Copy the choice made in step 1 into a fresh mutable buffer.
   3. Traverse over each byte of the argument _not_ chosen in step 1, and
      combine each of those bytes with the byte at the corresponding index of
      the fresh mutable buffer from step 2 (`.&amp;.` for `andByteString`,
      `.|.` for `orByteString`, `xor` for `xorByteString`).

  We also make use of loop sectioning to optimize this operation: see Note
  [Loop sectioning] explaining why we do this. Fundamentally, this doesn't
  change the logic of the operation, but means that step 3 is split into
  two smaller sub-steps: we first word 8 bytes at a time, then one byte at a
  time to finish up if necessary. Other than the choice of 'combining
  operation', the structure of the computation is the same, which suggests that
  we want a helper function with a signature like

  helper1 ::
    (Word64 -&gt; Word64 -&gt; Word64) -&gt;
    (Word8 -&gt; Word8 -&gt; Word8) -&gt;
    ByteString -&gt;
    ByteString -&gt;
    Int -&gt;
    ByteString

  or possibly (to avoid duplicate argument passing) like

  helper2 ::
    (forall (a :: Type) . Bits a =&gt; a -&gt; a -&gt; a) -&gt;
    ByteString -&gt;
    ByteString -&gt;
    Int -&gt;
    ByteString

  This would allow us to share all this logic, and have each of the 'top-level'
  operations just dispatch to either of the helpers with the appropriate
  function argument(s). Instead, we chose to write a manual copy of this logic
  for each of the 'top-level' operations, substituting only the 'combining
  operation'.

  We made this choice as any design based on either `helper1` or `helper2` is
  significantly slower (at least 50% worse, and the penalty _percentage_ grows
  with argument size). While `helper2` is significantly more penalizing than
  `helper1`, even `helper1` reaches an almost threefold slowdown at the higher
  input sizes we are interested in relative the manual version we use here.
  Due to the 'low-level' nature of Plutus Core primops, we consider these costs
  unacceptable relative the (small) benefits to code clarity and maintainability
  any solution using either style of helper would provide.

  The reason for `helper2` under-performing is unsurprising: any argument whose
  type is rank-2 polymorphic with a dictionary constraint essentially acts as
  a 'program template', which gets interpreted at runtime given some dictionary
  for a `Bits` instance. GHC can do practically nothing to optimize this, as
  there is no way to tell, for any given argument, _which_ definitions of an
  instance would be required here, even if the set of operations we use is
  finite, since any instance can make use of the full power of Haskell, which
  essentially lands us in Rice's Theorem territory. For `helper1`, the reasons
  are similar: it _must_ be able to work regardless of what functions (assuming
  appropriate types) it is given, which means in general, GHC is forced to
  compile mother-may-I-style code involving pointer chasing those arguments at
  runtime. This explains why the 'blowup' becomes worse with argument length.

  While in theory inlining could help with at least the `helper1` case (
  `helper2` is beyond that technique), it doesn't seem like GHC is able to
  figure this out, even with `INLINE` is placed on `helper1`.
  -}</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><span class="hs-comment">-- | Bitwise logical AND, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md).</span></span><span>
</span><span id="line-106"></span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#andByteString"><span class="hs-pragma hs-type">andByteString</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-107"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#andByteString"><span class="hs-identifier hs-type">andByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-108"></span><span id="andByteString"><span class="annot"><span class="annottext">andByteString :: Bool -&gt; ByteString -&gt; ByteString -&gt; ByteString
</span><a href="PlutusCore.Bitwise.Logical.html#andByteString"><span class="hs-identifier hs-var hs-var">andByteString</span></a></span></span><span> </span><span id="local-6989586621681612954"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681612954"><span class="hs-identifier hs-var">shouldPad</span></a></span></span><span> </span><span id="local-6989586621681612955"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612955"><span class="hs-identifier hs-var">bs1</span></a></span></span><span> </span><span id="local-6989586621681612956"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612956"><span class="hs-identifier hs-var">bs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681612958"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612958"><span class="hs-identifier hs-var">shorter</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681612959"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612959"><span class="hs-identifier hs-var">longer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612955"><span class="hs-identifier hs-var">bs1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612956"><span class="hs-identifier hs-var">bs2</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612955"><span class="hs-identifier hs-var">bs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612956"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612956"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612955"><span class="hs-identifier hs-var">bs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681612962"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612962"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681612963"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612963"><span class="hs-identifier hs-var">toTraverse</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681612954"><span class="hs-identifier hs-var">shouldPad</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612959"><span class="hs-identifier hs-var">longer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612958"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612958"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612959"><span class="hs-identifier hs-var">longer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="#local-6989586621681612964"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612962"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612963"><span class="hs-identifier hs-var">toTraverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612958"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><a href="#local-6989586621681612964"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621681612964"><span class="annot"><span class="annottext">go :: ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="#local-6989586621681612964"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681612965"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612965"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span> </span><span id="local-6989586621681612966"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612966"><span class="hs-identifier hs-var">toTraverse</span></a></span></span><span> </span><span id="local-6989586621681612967"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612967"><span class="hs-identifier hs-var">traverseLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-115"></span><span>      </span><span class="annot"><span class="annottext">IO ByteString -&gt; ByteString
forall a. IO a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; ByteString)
-&gt; ((CStringLen -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (CStringLen -&gt; IO ByteString)
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (CStringLen -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCStringLen</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612965"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">((CStringLen -&gt; IO ByteString) -&gt; ByteString)
-&gt; (CStringLen -&gt; IO ByteString) -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681612970"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681612970"><span class="hs-identifier hs-var">copyPtr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681612971"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612971"><span class="hs-identifier hs-var">copyLen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (Ptr CChar -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCString</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612966"><span class="hs-identifier hs-var">toTraverse</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681612973"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681612973"><span class="hs-identifier hs-var">traversePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-117"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BSI.create</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612971"><span class="hs-identifier hs-var">copyLen</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ByteString)
-&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681612975"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612975"><span class="hs-identifier hs-var">dstPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>            </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
forall a. Ptr a -&gt; Ptr a -&gt; Int -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612975"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681612970"><span class="hs-identifier hs-var">copyPtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612971"><span class="hs-identifier hs-var">copyLen</span></a></span><span>
</span><span id="line-119"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681612978"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612978"><span class="hs-identifier hs-var">bigStrides</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681612979"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612979"><span class="hs-identifier hs-var">littleStrides</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612967"><span class="hs-identifier hs-var">traverseLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Int)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#quotRem"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-120"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681612983"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621681612983"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612978"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-121"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681612985"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681612985"><span class="hs-identifier hs-var">bigDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612975"><span class="hs-identifier hs-var">dstPtr</span></a></span><span>
</span><span id="line-122"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681612986"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681612986"><span class="hs-identifier hs-var">bigTraversePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681612973"><span class="hs-identifier hs-var">traversePtr</span></a></span><span>
</span><span id="line-123"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612978"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681612987"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612987"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-124"></span><span>              </span><span id="local-6989586621681612988"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681612988"><span class="hs-identifier hs-var">w64_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681612985"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612987"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-125"></span><span>              </span><span id="local-6989586621681612989"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681612989"><span class="hs-identifier hs-var">w64_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681612986"><span class="hs-identifier hs-var">bigTraversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612987"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-126"></span><span>              </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; Word64 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681612985"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612987"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO ()) -&gt; Word64 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681612988"><span class="hs-identifier hs-var">w64_1</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#.%26."><span class="hs-operator hs-var">Bits..&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681612989"><span class="hs-identifier hs-var">w64_2</span></a></span><span>
</span><span id="line-127"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681612991"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612991"><span class="hs-identifier hs-var">smallDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612975"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612983"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-128"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681612992"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612992"><span class="hs-identifier hs-var">smallTraversePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681612973"><span class="hs-identifier hs-var">traversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612983"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-129"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612979"><span class="hs-identifier hs-var">littleStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681612993"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612993"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>              </span><span id="local-6989586621681612994"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681612994"><span class="hs-identifier hs-var">w8_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612991"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612993"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-131"></span><span>              </span><span id="local-6989586621681612995"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681612995"><span class="hs-identifier hs-var">w8_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612992"><span class="hs-identifier hs-var">smallTraversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612993"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-132"></span><span>              </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681612991"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681612993"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; IO ()) -&gt; Word8 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681612994"><span class="hs-identifier hs-var">w8_1</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#.%26."><span class="hs-operator hs-var">Bits..&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681612995"><span class="hs-identifier hs-var">w8_2</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="annot"><span class="hs-comment">-- | Bitwise logical OR, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md).</span></span><span>
</span><span id="line-135"></span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#orByteString"><span class="hs-pragma hs-type">orByteString</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-136"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#orByteString"><span class="hs-identifier hs-type">orByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-137"></span><span id="orByteString"><span class="annot"><span class="annottext">orByteString :: Bool -&gt; ByteString -&gt; ByteString -&gt; ByteString
</span><a href="PlutusCore.Bitwise.Logical.html#orByteString"><span class="hs-identifier hs-var hs-var">orByteString</span></a></span></span><span> </span><span id="local-6989586621681612996"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681612996"><span class="hs-identifier hs-var">shouldPad</span></a></span></span><span> </span><span id="local-6989586621681612997"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612997"><span class="hs-identifier hs-var">bs1</span></a></span></span><span> </span><span id="local-6989586621681612998"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612998"><span class="hs-identifier hs-var">bs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613000"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613000"><span class="hs-identifier hs-var">shorter</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613001"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613001"><span class="hs-identifier hs-var">longer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612997"><span class="hs-identifier hs-var">bs1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612998"><span class="hs-identifier hs-var">bs2</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612997"><span class="hs-identifier hs-var">bs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612998"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612998"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681612997"><span class="hs-identifier hs-var">bs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681613002"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613002"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613003"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613003"><span class="hs-identifier hs-var">toTraverse</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681612996"><span class="hs-identifier hs-var">shouldPad</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613001"><span class="hs-identifier hs-var">longer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613000"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613000"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613001"><span class="hs-identifier hs-var">longer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="#local-6989586621681613004"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613002"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613003"><span class="hs-identifier hs-var">toTraverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613000"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="#local-6989586621681613004"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621681613004"><span class="annot"><span class="annottext">go :: ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="#local-6989586621681613004"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681613005"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613005"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span> </span><span id="local-6989586621681613006"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613006"><span class="hs-identifier hs-var">toTraverse</span></a></span></span><span> </span><span id="local-6989586621681613007"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613007"><span class="hs-identifier hs-var">traverseLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><span class="annottext">IO ByteString -&gt; ByteString
forall a. IO a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; ByteString)
-&gt; ((CStringLen -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (CStringLen -&gt; IO ByteString)
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (CStringLen -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCStringLen</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613005"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">((CStringLen -&gt; IO ByteString) -&gt; ByteString)
-&gt; (CStringLen -&gt; IO ByteString) -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681613008"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613008"><span class="hs-identifier hs-var">copyPtr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613009"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613009"><span class="hs-identifier hs-var">copyLen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (Ptr CChar -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCString</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613006"><span class="hs-identifier hs-var">toTraverse</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613010"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613010"><span class="hs-identifier hs-var">traversePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BSI.create</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613009"><span class="hs-identifier hs-var">copyLen</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ByteString)
-&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613011"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613011"><span class="hs-identifier hs-var">dstPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>            </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
forall a. Ptr a -&gt; Ptr a -&gt; Int -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613011"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613008"><span class="hs-identifier hs-var">copyPtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613009"><span class="hs-identifier hs-var">copyLen</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613014"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613014"><span class="hs-identifier hs-var">bigStrides</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613015"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613015"><span class="hs-identifier hs-var">littleStrides</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613007"><span class="hs-identifier hs-var">traverseLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Int)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#quotRem"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613018"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621681613018"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613014"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-150"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613019"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613019"><span class="hs-identifier hs-var">bigDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613011"><span class="hs-identifier hs-var">dstPtr</span></a></span><span>
</span><span id="line-151"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613020"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613020"><span class="hs-identifier hs-var">bigTraversePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613010"><span class="hs-identifier hs-var">traversePtr</span></a></span><span>
</span><span id="line-152"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613014"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613021"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613021"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>              </span><span id="local-6989586621681613022"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613022"><span class="hs-identifier hs-var">w64_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613019"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613021"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-154"></span><span>              </span><span id="local-6989586621681613023"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613023"><span class="hs-identifier hs-var">w64_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613020"><span class="hs-identifier hs-var">bigTraversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613021"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-155"></span><span>              </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; Word64 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613019"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613021"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO ()) -&gt; Word64 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613022"><span class="hs-identifier hs-var">w64_1</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">Bits..|.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613023"><span class="hs-identifier hs-var">w64_2</span></a></span><span>
</span><span id="line-156"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613025"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613025"><span class="hs-identifier hs-var">smallDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613011"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613018"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-157"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613026"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613026"><span class="hs-identifier hs-var">smallTraversePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613010"><span class="hs-identifier hs-var">traversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613018"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613015"><span class="hs-identifier hs-var">littleStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613027"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613027"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>              </span><span id="local-6989586621681613028"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613028"><span class="hs-identifier hs-var">w8_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613025"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613027"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-160"></span><span>              </span><span id="local-6989586621681613029"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613029"><span class="hs-identifier hs-var">w8_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613026"><span class="hs-identifier hs-var">smallTraversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613027"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-161"></span><span>              </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613025"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613027"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; IO ()) -&gt; Word8 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613028"><span class="hs-identifier hs-var">w8_1</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#.%7C."><span class="hs-operator hs-var">Bits..|.</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613029"><span class="hs-identifier hs-var">w8_2</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="annot"><span class="hs-comment">-- | Bitwise logical XOR, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md).</span></span><span>
</span><span id="line-164"></span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#xorByteString"><span class="hs-pragma hs-type">xorByteString</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-165"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#xorByteString"><span class="hs-identifier hs-type">xorByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-166"></span><span id="xorByteString"><span class="annot"><span class="annottext">xorByteString :: Bool -&gt; ByteString -&gt; ByteString -&gt; ByteString
</span><a href="PlutusCore.Bitwise.Logical.html#xorByteString"><span class="hs-identifier hs-var hs-var">xorByteString</span></a></span></span><span> </span><span id="local-6989586621681613030"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681613030"><span class="hs-identifier hs-var">shouldPad</span></a></span></span><span> </span><span id="local-6989586621681613031"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613031"><span class="hs-identifier hs-var">bs1</span></a></span></span><span> </span><span id="local-6989586621681613032"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613032"><span class="hs-identifier hs-var">bs2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613034"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613034"><span class="hs-identifier hs-var">shorter</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613035"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613035"><span class="hs-identifier hs-var">longer</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613031"><span class="hs-identifier hs-var">bs1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613032"><span class="hs-identifier hs-var">bs2</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613031"><span class="hs-identifier hs-var">bs1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613032"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613032"><span class="hs-identifier hs-var">bs2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613031"><span class="hs-identifier hs-var">bs1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621681613036"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613036"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613037"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613037"><span class="hs-identifier hs-var">toTraverse</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681613030"><span class="hs-identifier hs-var">shouldPad</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613035"><span class="hs-identifier hs-var">longer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613034"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613034"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613035"><span class="hs-identifier hs-var">longer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="#local-6989586621681613038"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613036"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613037"><span class="hs-identifier hs-var">toTraverse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613034"><span class="hs-identifier hs-var">shorter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="#local-6989586621681613038"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621681613038"><span class="annot"><span class="annottext">go :: ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="#local-6989586621681613038"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621681613039"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613039"><span class="hs-identifier hs-var">toCopy</span></a></span></span><span> </span><span id="local-6989586621681613040"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613040"><span class="hs-identifier hs-var">toTraverse</span></a></span></span><span> </span><span id="local-6989586621681613041"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613041"><span class="hs-identifier hs-var">traverseLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><span class="annottext">IO ByteString -&gt; ByteString
forall a. IO a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; ByteString)
-&gt; ((CStringLen -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (CStringLen -&gt; IO ByteString)
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (CStringLen -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCStringLen</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613039"><span class="hs-identifier hs-var">toCopy</span></a></span><span> </span><span class="annot"><span class="annottext">((CStringLen -&gt; IO ByteString) -&gt; ByteString)
-&gt; (CStringLen -&gt; IO ByteString) -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681613042"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613042"><span class="hs-identifier hs-var">copyPtr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613043"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613043"><span class="hs-identifier hs-var">copyLen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-174"></span><span>        </span><span class="annot"><span class="annottext">ByteString -&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (Ptr CChar -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCString</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613040"><span class="hs-identifier hs-var">toTraverse</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613044"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613044"><span class="hs-identifier hs-var">traversePtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BSI.create</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613043"><span class="hs-identifier hs-var">copyLen</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ByteString)
-&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613045"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613045"><span class="hs-identifier hs-var">dstPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>            </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
forall a. Ptr a -&gt; Ptr a -&gt; Int -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613045"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613042"><span class="hs-identifier hs-var">copyPtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613043"><span class="hs-identifier hs-var">copyLen</span></a></span><span>
</span><span id="line-177"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613048"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613048"><span class="hs-identifier hs-var">bigStrides</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613049"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613049"><span class="hs-identifier hs-var">littleStrides</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613041"><span class="hs-identifier hs-var">traverseLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Int)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#quotRem"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-178"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613052"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621681613052"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613048"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-179"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613053"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613053"><span class="hs-identifier hs-var">bigDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613045"><span class="hs-identifier hs-var">dstPtr</span></a></span><span>
</span><span id="line-180"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613054"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613054"><span class="hs-identifier hs-var">bigTraversePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613044"><span class="hs-identifier hs-var">traversePtr</span></a></span><span>
</span><span id="line-181"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613048"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613055"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613055"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>              </span><span id="local-6989586621681613056"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613056"><span class="hs-identifier hs-var">w64_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613053"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613055"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-183"></span><span>              </span><span id="local-6989586621681613057"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613057"><span class="hs-identifier hs-var">w64_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613054"><span class="hs-identifier hs-var">bigTraversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613055"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-184"></span><span>              </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; Word64 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613053"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613055"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO ()) -&gt; Word64 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#xor"><span class="hs-identifier hs-var">Bits.xor</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613056"><span class="hs-identifier hs-var">w64_1</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613057"><span class="hs-identifier hs-var">w64_2</span></a></span><span>
</span><span id="line-185"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613059"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613059"><span class="hs-identifier hs-var">smallDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613045"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613052"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-186"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613060"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613060"><span class="hs-identifier hs-var">smallTraversePtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613044"><span class="hs-identifier hs-var">traversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613052"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613049"><span class="hs-identifier hs-var">littleStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613061"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613061"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>              </span><span id="local-6989586621681613062"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613062"><span class="hs-identifier hs-var">w8_1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613059"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613061"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-189"></span><span>              </span><span id="local-6989586621681613063"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613063"><span class="hs-identifier hs-var">w8_2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613060"><span class="hs-identifier hs-var">smallTraversePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613061"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-190"></span><span>              </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613059"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613061"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; IO ()) -&gt; Word8 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#xor"><span class="hs-identifier hs-var">Bits.xor</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613062"><span class="hs-identifier hs-var">w8_1</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613063"><span class="hs-identifier hs-var">w8_2</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="annot"><span class="hs-comment">-- | Bitwise logical complement, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md).</span></span><span>
</span><span id="line-193"></span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#complementByteString"><span class="hs-pragma hs-type">complementByteString</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-194"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#complementByteString"><span class="hs-identifier hs-type">complementByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-195"></span><span id="complementByteString"><span class="annot"><span class="annottext">complementByteString :: ByteString -&gt; ByteString
</span><a href="PlutusCore.Bitwise.Logical.html#complementByteString"><span class="hs-identifier hs-var hs-var">complementByteString</span></a></span></span><span> </span><span id="local-6989586621681613064"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613064"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; ByteString
forall a. IO a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; ByteString)
-&gt; ((CStringLen -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (CStringLen -&gt; IO ByteString)
-&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (CStringLen -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (CStringLen -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCStringLen</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613064"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">((CStringLen -&gt; IO ByteString) -&gt; ByteString)
-&gt; (CStringLen -&gt; IO ByteString) -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681613065"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613065"><span class="hs-identifier hs-var">srcPtr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613066"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613066"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-comment">-- We use loop sectioning here; see Note [Loop sectioning] as to why we do this</span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613069"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613069"><span class="hs-identifier hs-var">bigStrides</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613070"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613070"><span class="hs-identifier hs-var">littleStrides</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613066"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Int)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#quotRem"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613073"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621681613073"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613069"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BSI.create</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613066"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ByteString)
-&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613074"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613074"><span class="hs-identifier hs-var">dstPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613075"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613075"><span class="hs-identifier hs-var">bigSrcPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613065"><span class="hs-identifier hs-var">srcPtr</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613076"><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613076"><span class="hs-identifier hs-var">bigDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">Word64</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word64
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613074"><span class="hs-identifier hs-var">dstPtr</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613069"><span class="hs-identifier hs-var">bigStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613077"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613077"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>      </span><span id="local-6989586621681613078"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613078"><span class="hs-identifier hs-var">w64</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; IO Word64
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613075"><span class="hs-identifier hs-var">bigSrcPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613077"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><span class="annottext">Ptr Word64 -&gt; Int -&gt; Word64 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word64
</span><a href="#local-6989586621681613076"><span class="hs-identifier hs-var">bigDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613077"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO ()) -&gt; (Word64 -&gt; Word64) -&gt; Word64 -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64
forall a. Bits a =&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#complement"><span class="hs-identifier hs-var">Bits.complement</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; IO ()) -&gt; Word64 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681613078"><span class="hs-identifier hs-var">w64</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613080"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613080"><span class="hs-identifier hs-var">smallSrcPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr CChar -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613065"><span class="hs-identifier hs-var">srcPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613073"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613081"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613081"><span class="hs-identifier hs-var">smallDstPtr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Ptr Word8
forall a b. Ptr a -&gt; Int -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#plusPtr"><span class="hs-identifier hs-var">plusPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613074"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613073"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">[Int] -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#for_"><span class="hs-identifier hs-var">for_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613070"><span class="hs-identifier hs-var">littleStrides</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">((Int -&gt; IO ()) -&gt; IO ()) -&gt; (Int -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613082"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613082"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>      </span><span id="local-6989586621681613083"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613083"><span class="hs-identifier hs-var">w8</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekElemOff"><span class="hs-identifier hs-var">peekElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613080"><span class="hs-identifier hs-var">smallSrcPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613082"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall a. Storable a =&gt; Ptr a -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeElemOff"><span class="hs-identifier hs-var">pokeElemOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613081"><span class="hs-identifier hs-var">smallDstPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613082"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; IO ()) -&gt; (Word8 -&gt; Word8) -&gt; Word8 -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#complement"><span class="hs-identifier hs-var">Bits.complement</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; IO ()) -&gt; Word8 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613083"><span class="hs-identifier hs-var">w8</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="annot"><span class="hs-comment">-- | Bit read at index, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md)</span></span><span>
</span><span id="line-212"></span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#readBit"><span class="hs-pragma hs-type">readBit</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-213"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#readBit"><span class="hs-identifier hs-type">readBit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinResult"><span class="hs-identifier hs-type">BuiltinResult</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-214"></span><span id="readBit"><span class="annot"><span class="annottext">readBit :: ByteString -&gt; Int -&gt; BuiltinResult Bool
</span><a href="PlutusCore.Bitwise.Logical.html#readBit"><span class="hs-identifier hs-var hs-var">readBit</span></a></span></span><span> </span><span id="local-6989586621681613084"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613084"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681613085"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613085"><span class="hs-identifier hs-var">ix</span></a></span></span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613085"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;readBit: index out of bounds&quot;</span></span><span>
</span><span id="line-217"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Index: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; (Int -&gt; String) -&gt; Int -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Text) -&gt; Int -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613085"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>      </span><span class="annot"><span class="annottext">BuiltinResult Bool
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613085"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613087"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;readBit: index out of bounds&quot;</span></span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Index: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; (Int -&gt; String) -&gt; Int -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Text) -&gt; Int -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613085"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">BuiltinResult Bool
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613090"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613090"><span class="hs-identifier hs-var">bigIx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613091"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613091"><span class="hs-identifier hs-var">littleIx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613085"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; (Int, Int)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#quotRem"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-225"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613095"><span class="annot"><span class="annottext">flipIx :: Int
</span><a href="#local-6989586621681613095"><span class="hs-identifier hs-var hs-var">flipIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613087"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613090"><span class="hs-identifier hs-var">bigIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; BuiltinResult Bool
forall a. a -&gt; BuiltinResult a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; BuiltinResult Bool) -&gt; Bool -&gt; BuiltinResult Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Bool
forall a. Bits a =&gt; a -&gt; Int -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#testBit"><span class="hs-identifier hs-var">Bits.testBit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasCallStack =&gt; ByteString -&gt; Int -&gt; Word8
ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">BS.index</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613084"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613095"><span class="hs-identifier hs-var">flipIx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613091"><span class="hs-identifier hs-var">littleIx</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><a href="#local-6989586621681613087"><span class="hs-identifier hs-type">len</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621681613087"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621681613087"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613084"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="annot"><span class="hs-comment">-- | Bulk bit write, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md)</span></span><span>
</span><span id="line-232"></span><span class="hs-pragma">{-# INLINEABLE</span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#writeBits"><span class="hs-pragma hs-type">writeBits</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-233"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#writeBits"><span class="hs-identifier hs-type">writeBits</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinResult"><span class="hs-identifier hs-type">BuiltinResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-234"></span><span id="writeBits"><span class="annot"><span class="annottext">writeBits :: ByteString -&gt; [(Integer, Bool)] -&gt; BuiltinResult ByteString
</span><a href="PlutusCore.Bitwise.Logical.html#writeBits"><span class="hs-identifier hs-var hs-var">writeBits</span></a></span></span><span> </span><span id="local-6989586621681613098"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613098"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621681613099"><span class="annot"><span class="annottext">[(Integer, Bool)]
</span><a href="#local-6989586621681613099"><span class="hs-identifier hs-var">changelist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IO (Either WriteBitsException ByteString)
-&gt; Either WriteBitsException ByteString
forall a. IO a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.IO.Unsafe.html#unsafeDupablePerformIO"><span class="hs-identifier hs-var">unsafeDupablePerformIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Either WriteBitsException ByteString)
 -&gt; Either WriteBitsException ByteString)
-&gt; (IO ByteString -&gt; IO (Either WriteBitsException ByteString))
-&gt; IO ByteString
-&gt; Either WriteBitsException ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; IO (Either WriteBitsException ByteString)
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Control.Exception.Base.html#try"><span class="hs-identifier hs-var">try</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; Either WriteBitsException ByteString)
-&gt; IO ByteString -&gt; Either WriteBitsException ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO ByteString
</span><a href="#local-6989586621681613100"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#WriteBitsException"><span class="hs-identifier hs-type">WriteBitsException</span></a></span><span> </span><span id="local-6989586621681613102"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613102"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;writeBits: index out of bounds&quot;</span></span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; BuiltinResult ()) -&gt; Text -&gt; BuiltinResult ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Index: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; (Integer -&gt; String) -&gt; Integer -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Text) -&gt; Integer -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613102"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>    </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621681613103"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613103"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BuiltinResult ByteString
forall a. a -&gt; BuiltinResult a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613103"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-comment">-- This is written in a somewhat strange way. See Note [writeBits and</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- exceptions], which covers why we did this.</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><a href="#local-6989586621681613100"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621681613100"><span class="annot"><span class="annottext">go :: IO ByteString
</span><a href="#local-6989586621681613100"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a. ByteString -&gt; (Ptr CChar -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">BS.useAsCString</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613098"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString)
-&gt; (Ptr CChar -&gt; IO ByteString) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613104"><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613104"><span class="hs-identifier hs-var">srcPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
</span><span class="hs-identifier hs-var">BSI.create</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613105"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">((Ptr Word8 -&gt; IO ()) -&gt; IO ByteString)
-&gt; (Ptr Word8 -&gt; IO ()) -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681613106"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613106"><span class="hs-identifier hs-var">dstPtr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>            </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Ptr Word8 -&gt; Int -&gt; IO ()
forall a. Ptr a -&gt; Ptr a -&gt; Int -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Marshal.Utils.html#copyBytes"><span class="hs-identifier hs-var">copyBytes</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613106"><span class="hs-identifier hs-var">dstPtr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr CChar -&gt; Ptr Word8
forall a b. Ptr a -&gt; Ptr b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#castPtr"><span class="hs-identifier hs-var">castPtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr CChar
</span><a href="#local-6989586621681613104"><span class="hs-identifier hs-var">srcPtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613105"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="annot"><span class="annottext">((Integer, Bool) -&gt; IO ()) -&gt; [(Integer, Bool)] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Data.Foldable.html#traverse_"><span class="hs-identifier hs-var">traverse_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ptr Word8 -&gt; (Integer, Bool) -&gt; IO ()
</span><a href="#local-6989586621681613107"><span class="hs-identifier hs-var">setAtIx</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613106"><span class="hs-identifier hs-var">dstPtr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Integer, Bool)]
</span><a href="#local-6989586621681613099"><span class="hs-identifier hs-var">changelist</span></a></span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><a href="#local-6989586621681613105"><span class="hs-identifier hs-type">len</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-249"></span><span>    </span><span id="local-6989586621681613105"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621681613105"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681613098"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><a href="#local-6989586621681613108"><span class="hs-identifier hs-type">bitLen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621681613108"><span class="annot"><span class="annottext">bitLen :: Integer
</span><a href="#local-6989586621681613108"><span class="hs-identifier hs-var hs-var">bitLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613105"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#%2A"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">8</span></span><span>
</span><span id="line-252"></span><span>    </span><span class="annot"><a href="#local-6989586621681613107"><span class="hs-identifier hs-type">setAtIx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621681613107"><span class="annot"><span class="annottext">setAtIx :: Ptr Word8 -&gt; (Integer, Bool) -&gt; IO ()
</span><a href="#local-6989586621681613107"><span class="hs-identifier hs-var hs-var">setAtIx</span></a></span></span><span> </span><span id="local-6989586621681613109"><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613109"><span class="hs-identifier hs-var">ptr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613110"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613110"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613111"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681613111"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613110"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WriteBitsException -&gt; IO ()
forall a e. Exception e =&gt; e -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Exception.html#throw"><span class="hs-identifier hs-var">throw</span></a></span><span> </span><span class="annot"><span class="annottext">(WriteBitsException -&gt; IO ()) -&gt; WriteBitsException -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; WriteBitsException
</span><a href="PlutusCore.Bitwise.Logical.html#WriteBitsException"><span class="hs-identifier hs-var">WriteBitsException</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613110"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-255"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613110"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613108"><span class="hs-identifier hs-var">bitLen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WriteBitsException -&gt; IO ()
forall a e. Exception e =&gt; e -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Exception.html#throw"><span class="hs-identifier hs-var">throw</span></a></span><span> </span><span class="annot"><span class="annottext">(WriteBitsException -&gt; IO ()) -&gt; WriteBitsException -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; WriteBitsException
</span><a href="PlutusCore.Bitwise.Logical.html#WriteBitsException"><span class="hs-identifier hs-var">WriteBitsException</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613110"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-256"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613115"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613115"><span class="hs-identifier hs-var">bigIx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613116"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613116"><span class="hs-identifier hs-var">littleIx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613110"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; (Integer, Integer)
forall a. Integral a =&gt; a -&gt; a -&gt; (a, a)
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#quotRem"><span class="hs-operator hs-var">`quotRem`</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">8</span></span><span>
</span><span id="line-258"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613122"><span class="annot"><span class="annottext">flipIx :: Int
</span><a href="#local-6989586621681613122"><span class="hs-identifier hs-var hs-var">flipIx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613105"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613115"><span class="hs-identifier hs-var">bigIx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-259"></span><span>          </span><span id="local-6989586621681613123"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613123"><span class="hs-identifier hs-var">w8</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; IO Word8
forall b. Ptr b -&gt; Int -&gt; IO Word8
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; IO a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#peekByteOff"><span class="hs-identifier hs-var">peekByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613109"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613122"><span class="hs-identifier hs-var">flipIx</span></a></span><span>
</span><span id="line-260"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681613130"><span class="annot"><span class="annottext">toWrite :: Word8
</span><a href="#local-6989586621681613130"><span class="hs-identifier hs-var hs-var">toWrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681613111"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-261"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#setBit"><span class="hs-identifier hs-var">Bits.setBit</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613123"><span class="hs-identifier hs-var">w8</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word8) -&gt; (Integer -&gt; Int) -&gt; Integer -&gt; Word8
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Word8) -&gt; Integer -&gt; Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613116"><span class="hs-identifier hs-var">littleIx</span></a></span><span>
</span><span id="line-262"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; Word8
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Bits.html#clearBit"><span class="hs-identifier hs-var">Bits.clearBit</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613123"><span class="hs-identifier hs-var">w8</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word8) -&gt; (Integer -&gt; Int) -&gt; Integer -&gt; Word8
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Word8) -&gt; Integer -&gt; Word8
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621681613116"><span class="hs-identifier hs-var">littleIx</span></a></span><span>
</span><span id="line-263"></span><span>          </span><span class="annot"><span class="annottext">Ptr Word8 -&gt; Int -&gt; Word8 -&gt; IO ()
forall b. Ptr b -&gt; Int -&gt; Word8 -&gt; IO ()
forall a b. Storable a =&gt; Ptr b -&gt; Int -&gt; a -&gt; IO ()
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/Foreign.Storable.html#pokeByteOff"><span class="hs-identifier hs-var">pokeByteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr Word8
</span><a href="#local-6989586621681613109"><span class="hs-identifier hs-var">ptr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613122"><span class="hs-identifier hs-var">flipIx</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613130"><span class="hs-identifier hs-var">toWrite</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="annot"><span class="hs-comment">-- | Byte replication, as per [CIP-122](https://github.com/mlabs-haskell/CIPs/blob/koz/logic-ops/CIP-0122/CIP-0122.md)</span></span><span>
</span><span id="line-266"></span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#replicateByteString"><span class="hs-identifier hs-type">replicateByteString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#Int"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Word.html#Word8"><span class="hs-identifier hs-type">Word8</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.Result.html#BuiltinResult"><span class="hs-identifier hs-type">BuiltinResult</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-267"></span><span id="replicateByteString"><span class="annot"><span class="annottext">replicateByteString :: Int -&gt; Word8 -&gt; BuiltinResult ByteString
</span><a href="PlutusCore.Bitwise.Logical.html#replicateByteString"><span class="hs-identifier hs-var hs-var">replicateByteString</span></a></span></span><span> </span><span id="local-6989586621681613133"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613133"><span class="hs-identifier hs-var">len</span></a></span></span><span> </span><span id="local-6989586621681613134"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613134"><span class="hs-identifier hs-var">w8</span></a></span></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613133"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#%3C"><span class="hs-operator hs-var">&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; BuiltinResult ()
forall (m :: * -&gt; *). MonadEmitter m =&gt; Text -&gt; m ()
</span><a href="PlutusCore.Builtin.Emitter.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;byteStringReplicate: negative length requested&quot;</span></span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">BuiltinResult ByteString
forall err. AsEvaluationFailure err =&gt; err
</span><a href="PlutusCore.Evaluation.Result.html#evaluationFailure"><span class="hs-identifier hs-var">evaluationFailure</span></a></span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; BuiltinResult ByteString
forall a. a -&gt; BuiltinResult a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; BuiltinResult ByteString)
-&gt; (Word8 -&gt; ByteString) -&gt; Word8 -&gt; BuiltinResult ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8 -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681613133"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">(Word8 -&gt; BuiltinResult ByteString)
-&gt; Word8 -&gt; BuiltinResult ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621681613134"><span class="hs-identifier hs-var">w8</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- Helpers</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="hs-comment">{- Note [writeBits and exceptions]

   As `writeBits` allows us to pass a changelist argument of any length, we
   potentially could have an out-of-bounds index anywhere in the list. As we
   have to fail on such cases (and report them appropriately), we end up needing
   _both_ IO (to do mutable things) as well as a way to signal errors. We can
   do this in two ways:

   1. Pre-scan the changelist for any out-of-bounds indexes, fail if we see any,
      then apply the necessary changes if no out-of-bounds indexes are found.
   2. Speculatively allocate the new `ByteString`, then do the changes in the
      changelist argument one at a time, failing as soon as we see an out-of-bounds
      index.

  Option 1 would require traversing the changelist argument twice, which is
  undesirable, which means that option 2 is the more efficient choice. The
  natural choice for option 2 would be something similar to `ExceptT Int IO`
  (with the `Int` being an out-of-bounds index). However, we aren't able to do
  this, as ultimately, `ByteString`s are implemented as `ForeignPtr`s, forcing
  us to use the following function to interact with them, directly or not:

  withForeignPtr :: forall (a :: Type) . ForeignPtr a -&gt; (Ptr a -&gt; IO b) -&gt; IO b

  Notably, the function argument produces a result of `IO b`, whereas we would
  need `MonadIO m =&gt; m b` instead. This means that our _only_ choice is to
  use the exception mechanism, either directly or via some wrappers like
  `MonadUnliftIO`. While this is unusual, and arguably against the spirit of
  the use of `IO` relative `ByteString` construction, we don't have any other
  choice. We decided to use the exception mechanism directly, as while
  `MonadUnliftIO` is a bit cleaner, it ultimately ends up doing the same thing
  anyway, and this method at least makes it clear what we're doing.

  This doesn't pose any problems from the point of view of Plutus Core, as this
  exception cannot 'leak'; we handle it entirely within `writeBits`, and no
  other Plutus Core code can ever see it.
-}</span><span>
</span><span id="line-311"></span><span class="hs-keyword">newtype</span><span> </span><span id="WriteBitsException"><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#WriteBitsException"><span class="hs-identifier hs-var">WriteBitsException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="WriteBitsException"><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#WriteBitsException"><span class="hs-identifier hs-var">WriteBitsException</span></a></span></span><span> </span><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/ghc-bignum-1.3/src/GHC.Num.Integer.html#Integer"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681613137"><span id="local-6989586621681613141"><span class="annot"><span class="annottext">WriteBitsException -&gt; WriteBitsException -&gt; Bool
(WriteBitsException -&gt; WriteBitsException -&gt; Bool)
-&gt; (WriteBitsException -&gt; WriteBitsException -&gt; Bool)
-&gt; Eq WriteBitsException
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: WriteBitsException -&gt; WriteBitsException -&gt; Bool
== :: WriteBitsException -&gt; WriteBitsException -&gt; Bool
$c/= :: WriteBitsException -&gt; WriteBitsException -&gt; Bool
/= :: WriteBitsException -&gt; WriteBitsException -&gt; Bool
</span><a href="../../../ghc-9.6.5/html/libraries/ghc-prim-0.10.0/src/GHC.Classes.html#Eq"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681613146"><span id="local-6989586621681613150"><span id="local-6989586621681613154"><span class="annot"><span class="annottext">Int -&gt; WriteBitsException -&gt; ShowS
[WriteBitsException] -&gt; ShowS
WriteBitsException -&gt; String
(Int -&gt; WriteBitsException -&gt; ShowS)
-&gt; (WriteBitsException -&gt; String)
-&gt; ([WriteBitsException] -&gt; ShowS)
-&gt; Show WriteBitsException
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; WriteBitsException -&gt; ShowS
showsPrec :: Int -&gt; WriteBitsException -&gt; ShowS
$cshow :: WriteBitsException -&gt; String
show :: WriteBitsException -&gt; String
$cshowList :: [WriteBitsException] -&gt; ShowS
showList :: [WriteBitsException] -&gt; ShowS
</span><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621681613162"><span id="local-6989586621681613165"><span id="local-6989586621681613168"><span class="annot"><a href="../../../ghc-9.6.5/html/libraries/base-4.18.2.1/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Bitwise.Logical.html#WriteBitsException"><span class="hs-identifier hs-type">WriteBitsException</span></a></span></span></span></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="hs-comment">{- Note [Loop sectioning]

Several operations in this module effectively function as loops over bytes,
which have to be read, written, or both. Furthermore, we usually need to
process these bytes somehow, typically using fixed-width bitwise operations
from the Haskell side, thus allowing us to 'translate' these same operations
to the variable-width `ByteString` arguments we are dealing with. This involves
significant trafficking of data between memory and machine registers (as
`ByteString`s are wrapped counted arrays), as well as the overheads of looping
(involving comparisons and branches). This trafficking is necessary not only
to move the memory around, but also to process it, as on modern architectures,
data must first be moved into a register in order to do anything with it.

On all architectures of interest (essentially, 64-bit Tier 1), general-purpose
registers (GPRs henceforth) are 64 bits (or 8 bytes) wide. Furthermore, the
primary cost of moving data between memory and registers is having to overcome
the 'memory wall': the exact amount of data being moved doesn't affect this
much. In addition to this, when we operate on single bytes, the remaining 56
bits of the GPR holding that data are essentially 'wasted'. In the situation
we are in (namely, operating over arrays, whose data is adjacent in memory),
we thus get two sources of inefficiency:

* Despite paying the cost for a memory transfer, we move only one-eighth of
  the data we could; and
* Despite transferring data from memory to registers, we use these registers
  only at one-eighth capacity.

In short, we do _eight times_ more rotations of the loop, and memory moves,
than we need to!

To avoid this, we use a technique called _loop sectioning_. Effectively, this
transforms our homogenous loop (that always works one byte at a time) into a
heterogenous loop: first, we operate on a larger section (called a _stride_)
until we can no longer do this, and then we finish up using byte at a time
processing. Essentially, given an input like this:

[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10 ]

the homogeous byte-at-a-time approach would process it like so:

  _   _   _   _   _   _   _   _   _   _
[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10 ]

for a total of 10 memory transfers and 10 loop spins, whereas a loop-sectioned
approach with a stride of 8 would instead process like so:

  ______________________________  _   _
[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10 ]

This gives us only _three_ memory transfers and _three_ loop spins instead. This
effectively reduces our work by a factor of 8. In our cases, this is significant.

This technique only benefits us because counted arrays are cache-friendly: see
Note [Superscalarity and caching] for a longer explanation of this and why it
matters.

Further information:

- Tier 1 GHC platform list:
    https://gitlab.haskell.org/ghc/ghc/-/wikis/platforms#tier-1-platforms
- Memory wall:
    https://link.springer.com/referenceworkentry/10.1007/978-0-387-09766-4_234
- Loop sectioning in more detail:
    http://physics.ujep.cz/~zmoravec/prga/main_for/mergedProjects/optaps_for/common/optaps_vec_mine.htm
-}</span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-comment">{- Note [Superscalarity and caching]
On modern architectures, in order to process data, it must first be moved from
memory into a register. This operation has some cost (known as the 'memory wall'),
which is largely independent of how much data gets moved (assuming the register
can hold it): moving one byte, or a whole register's worth, costs about the same.
To reduce this cost, CPU manufacturers have introduced _cache hierarchies_,
which are designed to limit the cost of the wall, as long as the data access
matches the cache's optimal usage pattern. Thus, while an idealized view of
the memory hierachy is this:

Registers
---------
Memory

in reality, the view is more like this:

Registers
---------
L1 cache
---------
L2 cache
---------
L3 cache (on some platforms)
---------
Memory

Each 'higher' cache in the hierarchy is smaller, but faster, and when a memory
fetch is requested in code, in addition to moving the requested data to a
register, that data (plus some more) is moved into caches as well. The amount
of data moved into cache (a _cache line_) is typically eight machine words on
modern architectures (and definitely is the case for all Tier 1 GHC platforms):
for the cases concerning Plutus, that is 64 bytes. Therefore, if data we need
soon after a fetch is _physically_ nearby, it won't need to be fetched from
memory: instead, it would come from a cache, which is faster (by a considerable
margin).

To see how this can matter, consider the following ByteString:

[ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]

The ByteString (being a counted array) has all of its data physically adjacent
to each other. Suppose we wanted to fetch the byte at index 1 (second position).
The naive view of what happens is like this:

Registers: [b2] [ ] [ ] .... [ ]
Memory: [ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]

Thus, it would appear that, if we wanted a different position's value, we would
need to fetch from memory again. However, what _actually_ happens is more like this:

Registers: [b2] [ ] [ ] .... [ ]
L1 cache: [ b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]
Memory: [ b1, b2, b3, b4, b5, b6, b7, b8, b9, b10, b11 ]

We note that b2, as well as its adjacent elements, were _all_ pulled into the L1
cache. This can only work because all these elements are physically adjacent in
memory. The improvement in performance from this cache use is _very_ non-trivial:
an L1 cache is about 200 times faster than a memory access, and an L2 cache about
20 times faster.

To take further advantage of this, modern CPUs (and all Tier 1 GHC platforms have
this capability) are _superscalar_. To explain what this means, let's consider the
naive view of how CPUs execute instructions: namely, it is one-at-a-time, and
synchronous. While CPUs must give the _appearance_ that they behave this way, in
practice, CPU execution is very much asynchronous: due to the proliferation of ALUs
on a single chip, having twice as many processing units is much cheaper than having
processing units run twice as fast. Thus, if there are no data dependencies
between instructions, CPUs can (and do!) execute them simultaneously, stalling to
await results if a data dependency is detected. This can be done automatically
using Tomasulo's algorithm, which ensures no conflicts with maximum throughput.

Superscalarity interacts well with the cache hierarchy, as it makes data more
easily available for processing, provided there is enough 'work to do', and no
data dependencies. In our situation, most of what we do is data _movement_ from
one memory location to another, which by its very nature lacks any data
dependencies.

Further references:

- Numbers for cache and memory transfers: https://gist.github.com/jboner/2841832
- Superscalarity: https://en.wikipedia.org/wiki/Superscalar_processor
- Tomasulo's algorithm: https://en.wikipedia.org/wiki/Tomasulo%27s_algorithm
-}</span><span>
</span><span id="line-465"></span></pre></body></html>